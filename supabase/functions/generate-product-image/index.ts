const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { imageUrl, productName, style } = await req.json();

    if (!imageUrl) {
      return new Response(
        JSON.stringify({ success: false, error: 'Image URL is required' }),
        { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const LOVABLE_API_KEY = Deno.env.get('LOVABLE_API_KEY');
    if (!LOVABLE_API_KEY) {
      console.error('LOVABLE_API_KEY not configured');
      return new Response(
        JSON.stringify({ success: false, error: 'AI service not configured' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    // Define style prompts - focus on creating NEW images inspired by the product type
    const productDescription = productName || 'household product';
    
    const stylePrompts: Record<string, string> = {
      lifestyle: `IMPORTANT: Keep the EXACT product from the source image. Transform ONLY the background and lighting. Create a professional lifestyle photo with the product placed in an elegant modern setting (bathroom, kitchen, or living room). Use warm, inviting lighting. Premium aesthetic. Keep the product identical to the source image - do not change its appearance, color, or design. Only enhance the background and lighting.`,
      studio: `IMPORTANT: Keep the EXACT product from the source image. Transform ONLY the background. Create a professional studio product photo on a clean white or soft gradient background with professional studio lighting, subtle shadows and reflections. Premium clean look. The product must remain identical to the source image - only change the background to studio setting.`,
      outdoor: `IMPORTANT: Keep the EXACT product from the source image. Transform ONLY the background and lighting. Create a professional outdoor product photo with the product in a beautiful natural setting with soft natural lighting. Aspirational and appealing. Keep the product exactly as it appears in the source image - only change the environment to outdoor.`,
      minimal: `IMPORTANT: Keep the EXACT product from the source image. Transform ONLY the background. Create a minimalist product photo with clean simple background, soft shadows, modern elegant style. The product itself must remain unchanged from the source image - only modify the background to be minimal and clean.`,
    };

    const prompt = stylePrompts[style] || stylePrompts.lifestyle;

    console.log('Generating image with style:', style);
    console.log('Source image URL:', imageUrl);

    const response = await fetch('https://ai.gateway.lovable.dev/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${LOVABLE_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'google/gemini-2.5-flash-image-preview',
        messages: [
          {
            role: 'user',
            content: [
              {
                type: 'text',
                text: prompt,
              },
              {
                type: 'image_url',
                image_url: {
                  url: imageUrl,
                },
              },
            ],
          },
        ],
        modalities: ['image', 'text'],
      }),
    });

    if (!response.ok) {
      if (response.status === 429) {
        return new Response(
          JSON.stringify({ success: false, error: 'Rate limit exceeded, please try again later' }),
          { status: 429, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
        );
      }
      if (response.status === 402) {
        return new Response(
          JSON.stringify({ success: false, error: 'Please add credits to continue using AI features' }),
          { status: 402, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
        );
      }
      const errorText = await response.text();
      console.error('AI gateway error:', response.status, errorText);
      return new Response(
        JSON.stringify({ success: false, error: 'Failed to generate image' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    const data = await response.json();
    console.log('AI response received');

    // Extract the generated image from the response
    const generatedImageUrl = data.choices?.[0]?.message?.images?.[0]?.image_url?.url;

    if (!generatedImageUrl) {
      console.error('No image in response:', JSON.stringify(data));
      return new Response(
        JSON.stringify({ success: false, error: 'No image generated' }),
        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
      );
    }

    console.log('Image generated successfully');

    return new Response(
      JSON.stringify({
        success: true,
        data: {
          imageUrl: generatedImageUrl,
          style,
        },
      }),
      { headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  } catch (error) {
    console.error('Error generating image:', error);
    const errorMessage = error instanceof Error ? error.message : 'Failed to generate image';
    return new Response(
      JSON.stringify({ success: false, error: errorMessage }),
      { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
    );
  }
});
